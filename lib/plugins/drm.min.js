!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).flowplayer=e.flowplayer||{},e.flowplayer.drm=t())}(this,(function(){"use strict";var e="webkitneedkey",t="src",n="config",r=[].slice;function i(e,t){for(var n in t)e[n]=t[n];return e}function a(){var e=r.call(arguments),t=e.shift();return e.reduce(i,t)}function s(e,t,n){for(t=function(e){return Array.isArray(e)?e.slice(0):e.split(".")}(t);t.length;){if(null==e)return n;e=e[t.shift()]}return null==e?n:e}var o="com.widevine.alpha",f="com.microsoft.playready",u="org.w3.clearkey",c="com.apple.fps.1_0";function d(e){var t={};return Object.keys(e).forEach((function(n){var r;r=n,[o].filter((function(e){return e===r})).length&&function(e,t,n){if(e===o){n.widevineLicenseUrl=t[e].license_server,n.emeEnabled=!0;var r=t[e].http_headers;r&&(n.licenseXhrSetup=function(e){Object.keys(r).forEach((function(t){e.setRequestHeader(t,r[t])}))})}}(n,e,t)})),t}function l(e){var t={};return Object.keys(e).forEach((function(n){var r;r=n,[o,f,u].filter((function(e){return e===r})).length&&(t[n]=function(e,t){var n={serverURL:t[e].license_server};return t[e].http_headers&&(n.httpRequestHeaders=t[e].http_headers),n}(n,e))})),t}function y(e,t,n){var r,i,a;t[c]&&(e.src&&0===e.src.indexOf("blob:")||(r=t[c].certificate,i=function(r){e.webkitSetMediaKeys(new WebKitMediaKeys("com.apple.fps.1_0"));var i=n.initData,a=function(e){var t,n=(t=new Uint16Array(e.buffer),String.fromCharCode.apply(null,t));return n.substring(n.indexOf("skd:")).split(";")[1]}(i);i=function(e,t,n){"string"==typeof t&&(t=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0,i=e.length;r<i;r++)n[r]=e.charCodeAt(r);return n}(t));var r=0,i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+n.byteLength),a=new DataView(i);new Uint8Array(i,r,e.byteLength).set(e),r+=e.byteLength,a.setUint32(r,t.byteLength,!0),r+=4;var s=new Uint16Array(i,r,t.length);return s.set(t),r+=s.byteLength,a.setUint32(r,n.byteLength,!0),r+=4,new Uint8Array(i,r,n.byteLength).set(n),new Uint8Array(i,0,i.byteLength)}(i,a,r);var s=e.webkitKeys.createSession("application/x-mpegurl",i);s.addEventListener("webkitkeyerror",console.debug.bind(console,"webkitkeyerror")),s.addEventListener("webkitkeymessage",(function(e){var n,r,i,o;n=t[c].license_server,r={message:e.message,assetId:a},i=function(e){s.update(e)},(o=new XMLHttpRequest).responseType="arraybuffer",o.addEventListener("load",(function(){o.status>=400||i(new Uint8Array(o.response))}),!1),o.open("POST",n+r.assetId,!0),o.setRequestHeader("Content-type","application/octet-stream"),o.send(r.message)}))},(a=new XMLHttpRequest).responseType="arraybuffer",a.addEventListener("load",(function(){i(new Uint8Array(a.response))}),!1),a.open("GET",r,!0),a.send()))}function p(r,i,o){o.on(n,(function(e){r=e.data})),o.on(t,(function(t){if(t.data.drm){var n=s(r,"hls",{}),i=t.data.drm?d(t.data.drm):{};o.setOpts({hls:a(n,i)}),o.on(e,y.bind(null,o,t.data.drm||{}));var f=s(r,"dash",{}),u=t.data.drm?l(t.data.drm):{};o.setOpts({dash:a(f,{drm:u})})}}))}return a(p,Object.freeze({__proto__:null,WIDEVINE:o,PLAYREADY:f,CLEARKEY:u,FAIRPLAY:c,LICENSE_SERVER:"license_server",KEY:"key",KEY_ID:"kid",HTTP_HEADERS:"http_headers",CERTIFICATE:"certificate"})),function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});var n=e.flowplayer;"function"==typeof n?n(t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t))}(window,p),p}));
