!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t=t||self).flowplayer=t.flowplayer||{},t.flowplayer.ovp=e())}(this,(function(){"use strict";var t=[].slice;function e(){}function n(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];for(var o in e)t[o]=e[o];return t}function r(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return t.slice(1).reduce((function(t,e){return n(t,e)}),t[0]||{})}function o(t){return Array.isArray(t)?t.slice(0):t.split(".")}function a(t,e,n){for(var r=o(e);r.length;){if(null==t)return n;var a=r.shift();if("string"!=typeof a)return n;t=t[a]}return null==t?n:t}function i(t,e,n){var r=(e=o(e)).pop(),i=a(t,e);return i&&r&&(i[r]=n),t}function u(t){var e="number"==typeof t?t:parseInt(t,10);return(e>9?"":"0")+e}function c(t){return"function"==typeof t}function f(){throw new Error("Function was expected as Argument[0]")}var s=[].slice;function l(t){if(!(this instanceof l))return new l(t);var e=this;return e.data=t,e.tap=function(){var t=s.call(arguments),n=t.shift();return n==l.lift?e.data:c(n)?(n.apply(e,[e.data].concat(t)),e):void f()},e.into=e.fmap=function(){var t=s.call(arguments),n=t.shift();return n==l.lift?e.data:c(n)?l(n.apply(e,[e.data].concat(t))):void f()},e.unwrap=function(){return e.data},e}l.of=l,l.lift=function(t){return t instanceof l?t.data:t},l._apply=l.apply=function(t,e){if(0==e.length)return t();if(1==e.length)return t(e[0]);if(2==e.length)return t(e[0],e[1]);if(3==e.length)return t(e[0],e[1],e[2]);if(4==e.length)return t(e[0],e[1],e[2],e[3]);if(5==e.length)return t(e[0],e[1],e[2],e[3],e[4]);throw new Error("Pipe._apply() does not support arity > 5")},l.maybe=function(t,e,n){return t?l._apply(e,[t].concat(s.call(arguments,2,arguments.length))):t},l.curry=function(t,e,n){return(e=e||[]).length>t.length-1?t.apply(n,e):function(){var r=e.concat(s.call(arguments));return l.curry(t,r,n)}};var p=[].slice,d=Array.isArray;function m(t){return t&&"object"==typeof t&&"[object RegExp]"!==Object.prototype.toString.call(t)&&"[object Date]"!==Object.prototype.toString.call(t)}function v(t,e){return t.length===t.filter(e).length}function y(){return v(p.call(arguments),d)}function _(t,e){for(var n in t)e(n,t[n])}function h(t){return m(t)?d(t)?t.map(h):w({},t):t}function g(t,e){var n={};return _(t,(function(t,e){n[t]=h(e)})),function(t,e){return _(e,(function(e,n){if(void 0===t[e])return t[e]=h(n);t[e]=w(t[e],n)})),t}(n,e)}function w(t,e){return y(t,e)?function(t){return h(t)}(t):!1===t?t:!0===t&&!1!==e||!m(t)&&m(e)?e:void 0===t||m(t)?m(t)&&!m(e)?t:function(){return v(p.call(arguments),m)}(t,e)?g(t,e):void 0:t}function b(){return[].reduce.call(arguments,(function(t,e){return w(t,e)}),y.apply(null,arguments)?[]:{})}function E(){return b.apply(null,p.call(arguments).reverse())}function O(t,e){var r=new XMLHttpRequest;r.open("GET",t,!0),r.onreadystatechange=function(){try{var t=r.status;if(r.readyState<4)return;if(200!=t&&r.readyState>3&&"function"==typeof e.err){var o={status:t};try{n(o,JSON.parse(r.responseText))}catch(o){}return e.err(o)}e.ok(JSON.parse(r.responseText))}catch(o){console.error(o),e.err(o)}},r.send()}function j(){var t=[].join.call(arguments,"/");return"/"!==t[0]&&(t="/"+t),(flowplayer.OVP_API||"https://ljsp.lwcdn.com")+"/web/public/native/config"+t}function A(t){return~t.indexOf("/")?t:"/media/"+t}var C={404:"media not found",402:"invalid subscription",400:"bad request",415:"unsupported media type"};function x(t,e){var n=r({},t);return e.forEach((function(t){delete n[t]})),n}var S={media_id:"id",media_duration:"duration",media_name:"title",media_tags:"tags",category:"category_name",ad_keywords:"ad_keywords"};var T=["src","metadata","title","description","duration","poster"];function N(t){var e=a(t,"ima.ads");return Array.isArray(e)&&i(t,"ima.ads",e.map((function(e){return"number"==typeof e.percentage&&(e.time=e.percentage*t.duration),e}))),t}function L(t,e){e="object"==typeof e?e:{};var n={title:a(t,"metadata.title",null),description:a(t,"metadata.description",null)};return E({ima:{parameters:function(t,e,n){for(var r in n=n||{},t)n[r]=a(e||{},t[r]);return n}(S,a(t,"metadata",{}))}},n,t,x(e,T),x(e.embed||{},["src"]))}var P=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;function I(t){return"object"==typeof t&&"ovp/base64"==t.type}function k(t,e,n){return function(t,e){return!(~t.indexOf(".")||!P.test(t))&&(e.type="video/ovp",!0)}(t,e)||I(e)}function q(t){try{return R(decodeURIComponent(atob(t).split("").map((function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)})).join("")))}catch(t){return{err:t.message}}}function R(t){return null===t?{}:JSON.parse(t)}var M=Object.freeze({__proto__:null,base64:q,json:R});function D(t){var e=t.split(/[^0-9]/);return Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],e[5])}var V=Object.freeze({__proto__:null,OVP_ERROR:"ovp:error",OVP_MEDIA_REQUEST_START:"ovp:request:start",OVP_MEDIA_REQUEST_COMPLETE:"ovp:request:media:complete",OVP_PLAYLIST_REQUEST_COMPLETE:"ovp:request:playlist:complete",LIVE_COUNTDOWN_TICK:"ovp:live:countdown:tick",LIVE_COUNTDOWN_START:"ovp:live:countdown:start",LIVE_COUNTDOWN_COMPLETE:"ovp:live:countdown:complete"});function U(t,e){if(I(e))return H(t,e);l(e).fmap(a,"src").fmap(A).fmap(j).fmap(O,{ok:l.curry(W,[t]),err:l.curry(F,[t])})}function H(t,e){l(e).fmap(a,"src").fmap(l.maybe,q).fmap(l.maybe,l.curry(W,[t]))}function W(t,e){if(a(e,"playlist"))return z(t,e);if(a(e,"live"))return Q(t,e);if(a(e,"src"))return J(t,e);throw new Error("Status[200] >> unhandled case\n"+JSON.stringify(e,null,2))}function F(t,e){return e.message?t.emit("ovp:error",e):e.status?t.emit("ovp:error",new Error(C[e.status])):t.emit("ovp:error",e)}function J(t,e){t.emit("ovp:request:media:complete",l.of(e).fmap(L,t.opts).fmap(N).fmap(l.lift))}function z(t,e){if("function"!=typeof flowplayer.playlist)return console.warn("OVP responded with Playlist media but the playlist plugin does not exist"),F(t,{status:415});var n,o,i,u;t.emit("ovp:request:playlist:complete",(n=t.opts,o=e,i=r({},n),r(u=E({},o,a(n,"playlist",{})),{playlist:a(u,"playlist",[]).map((function(t){return L(t,i)}))})))}function Q(t,e){var n=a(e,"metadata.live_start_time",a(e,"metadata.starttime"));i(e,"live_start_time",l.of(n).fmap(D).fmap(l.lift)),t.emit("ovp:live:countdown:start",l.of(e).fmap(L,t.opts).fmap(N).fmap(l.lift))}var B={};function G(t,e){if("object"==typeof B[e])return console.debug("using Cache(%s)",e),K(t,e,B[e]);l(e).fmap(j).fmap(O,{ok:l.curry(K,[t,e]),err:console.error})}function K(t,e,n){"object"!=typeof B[e]&&(B[e]=n);var o=a(t,"opts",{}),u=a(o,"metadata",{});i(u,"player_id",e),["title","description"].forEach((function(t){!0===n[t]&&"string"==typeof o[t]&&i(n,t,a(o,t))})),i(o,"metadata",u);var c=r(o,n);t.setOpts(c),n.autoplay&&t.togglePlay(!0)}var X=Object.freeze({__proto__:null,fetch_unknown_media:U,handle_base64:H,handle_200:W,handle_err:F,handle_single_media:J,handle_playlist:z,handle_live:Q,fetch_player_id:G,handle_player_only:K}),Y=void 0;function Z(t,e,n){$()||l.of("recommendation").fmap(j,e,n).fmap(O,{err:tt,ok:l.curry(et,[t])})}function $(){return Y}function tt(t){Y=!0,console.error("Failed to load recommendations: %j",t)}function et(t,e){var n=e.playlist;i(t,"opts.recommendations",n),a(n,"length",0)&&t.emit("recommendationsready",{playlist:n.map((function(t){return{poster:t.poster,src:t.src,title:a(t,"metadata.title"),metadata:t.metadata||{}}}))})}var nt=!!function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("testPassive",null,e),window.removeEventListener("testPassive",null,e)}catch(t){}return t}()&&{passive:!0},rt=["touchstart","touchmove"];function ot(t){return t.emit=function(e,r,o){o=o||{};var a=function(t){var e=document.createEvent("Event");return e.initEvent(t,!1,!0),e}(e);return r&&n(a,{data:r||{}}),t.dispatchEvent(a),!1===o.return_self?a:t},t.on=function(e,n){return"string"==typeof e&&(e=e.split(" ")),e.forEach((function(e){return function(t){return~rt.indexOf(t)}(e)?t.addEventListener(e,n,nt):t.addEventListener(e,n)})),t},t.off=function(e,n){return t.removeEventListener(e,n),t},t.one=t.once=function(e,n){return t.on(e,(function r(o){t.off(e,r),n(o)}))},t}var at=Array.isArray,it="undefined"!=typeof window&&ot(window),ut="undefined"!=typeof document&&ot(document),ct=["span","a","em","p","i"],ft=ct.concat(["div","strong","video","img","ol","ul","li","script"]);function st(t,e,n){var r=pt(document.createElement(t));if(at(e)&&(n=e,e=!1),at(n)||(n=[n]),r.append(n.filter((function(t){return t}))),"object"!=typeof e)return r;for(var o in e)o in r?r[o]=e[o]:r.setAttribute(o,e[o]);return r}function lt(e){var n=e.tagName;e.__flowplayer__=1,e.find=function(t){var n=e.querySelector(t);return n?pt(n):n},e.html=function(t){return e.innerHTML=t,e},e.empty=function(){return e.innerHTML="",e},e.offset=function(){var t={top:0,left:0},n=e;do{t.left+=n.offsetLeft||0,t.top+=n.offsetTop||0}while(n=n.offsetParent);return t},e.innerWidth=function(){var t=getComputedStyle(e);return e.clientWidth-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight)};var r=e.insert=function(t,n){return at(n)?n.map((function(n){return e.insert(t,n)}))[0]:pt(n="string"==typeof n?e.insertAdjacentHTML(t,n):e.insertAdjacentElement?e.insertAdjacentElement(t,n):e.appendChild(n))};return e.append=r.bind(e,"beforeend"),e.prepend=r.bind(e,"afterbegin"),e.css=function(t,n){if("object"==typeof t){for(var r in t)e.css(r,t[r]);return e}return void 0===n?getComputedStyle(e)[t]:(1*n&&(n+="px"),e.style[t]=n,e)},e.show=function(){return e.css({display:~ct.indexOf(n)?"inline":"block"})},e.hide=function(){return e.css({display:"none"})},e.remove=function(){var t=e.parentNode;t&&t.removeChild(e)},e.attr=function(t,n){return null==n?e.getAttribute(t):(e.setAttribute(t,n),e)},e.txt=function(t){return e.textContent=t,e},e.fp=function(t){return e.addClass("fp-"+t)},e.addClass=function(t){return t.split(" ").forEach((function(t){e.hasClass(t)||(e.className+=(e.className?" ":"")+t)})),e},e.removeClass=function(t){t=t.split(" ");var n=e.className.split(" ");return e.className=n.filter((function(e){return!~t.indexOf(e)})).join(" "),e},e.toggleClass=function(t,n){return void 0===n&&(n=!e.hasClass(t)),n?e.addClass(t):e.removeClass(t)},e.findAll=function(n){return r=e.querySelectorAll(n),t.call(r);var r},e.hasClass=function(t){return~e.className.split(" ").indexOf(t)},e}function pt(t){return void 0===t||function(t){return t&&t.__flowplayer__}(t)?t:lt(ot(t))}function dt(t,e){if("string"==typeof t&&"<"==t[0])return st(t.slice(1,-1),e);if("string"!=typeof t)return pt(t);var n=e instanceof HTMLElement&&e.querySelector(".fp-"+t)||document.querySelector(t);return n?pt(n):void 0}function mt(t,n,r){if(!yt(t))return r.emit("ovp:request:media:complete",t);var o=n.append(dt.div({class:"fp-livecountdown"})),i=o.append(dt.div({class:"fp-inner"}));i.append(dt.p({},r._t("ovp.starting_in")));var c=i.append(dt.p({class:"fp-countdown"}));function f(t){var e=a(t,"data.remaining",-1);if(e<0||isNaN(e))return r.emit("ovp:live:countdown:complete");n.addClass("is-livecountdown"),c.txt(function(t){var e=function(t){"number"!=typeof t&&(t=parseInt(t,10)),t=Math.round(t);var e=Math.floor(t/86400);t-=86400*e;var n=Math.floor(t/3600);t-=3600*n;var r=Math.floor(t/60);return{days:e,hours:n,minutes:r,seconds:t-=60*r}}(t),n="";e.days&&(n+=e.days+":");return n+u(e.hours)+":"+u(e.minutes)+":"+u(e.seconds)}(e+1)),r.hasState("is-starting")||r.setState("is-starting",!0)}r.on("ovp:live:countdown:tick",f),r.one("ovp:live:countdown:complete",(function(){o.remove(),n.removeClass("is-livecountdown"),r.off("ovp:live:countdown:tick",f),r.emit("ovp:request:media:complete",t)})),function(t,n){var r,o;function i(){clearInterval(r),clearInterval(o)}function u(){return t=n.live_start_time,e=a(n,"server_time_offset",0),r=Date.now()-e,Math.floor((t-r)/1e3);var t,e,r}function c(){var e=u();if(t.emit("ovp:live:countdown:tick",{remaining:e}),e<0||0===t.reaper)return i()}function f(){var r,o;if(0===u()||0===t.reaper)return i();r=n,o={err:console.error,ok:e},O((flowplayer.OVP_API||"https://ljsp.lwcdn.com")+"/web/public/countdown/time.json",{err:o.err,ok:function(t){var e=Date.now()-t.millisUtc;o.ok(w(r,{server_time_offset:e}))}})}c()&&f(),r=setInterval(c,250),o=setInterval(f,1e4)}(r,t)}function vt(t,e,n){}function yt(t){return t&&t.live_start_time-Date.now()>0}dt.window=it,dt.document=ut,dt.el=st,ft.forEach((function(t){dt[t]=function(e,n){return"string"==typeof e&&(e={class:e}),st(t,e,n)}}));function _t(t,e,n){var r="flowplayer-ovp-branding-"+e;if(!t.hasClass(r)){!function(t){if(-1==t.className.indexOf("flowplayer-ovp-branding-"))return;t.className=t.className.split(" ").filter((function(t){return-1==t.indexOf("flowplayer-ovp-branding-")})).join(" ")}(t);var o=function(t){if(document.getElementById(t))return!1;var e=document.createElement("style");return e.id=t,e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet}(r);o&&(!function(t,e,n,r){if("insertRule"in t)return t.insertRule(e+"{"+n+"}",r);if("addRule"in t)t.addRule(e,n,r)}(o,"."+r+" .fp-color","background-color: #"+n+";"),t.addClass(r))}}function ht(t,e,n,r){if(4==arguments.length&&"object"==typeof r)return"string"!=typeof t.player_id||0===r.src.indexOf(t.player_id)||I(r)||(r.src=[t.player_id,r.src].join("/")),U(n,r);n.on("ovp:error",(function(t){n.emit("error",t.data)})),n.on("ovp:request:start",(function(){n.setState("is-waiting",!0),t.recommendations&&(t.recommendations=1)})),n.on("ovp:request:media:complete",(function(t){0==n.reaper||"object"!=typeof t.data||yt(t.data)||(n.setOpts(t.data),n.setAttrs(t.data),n.setSrc(a(t,"data.src")),t.data.autoplay&&n.togglePlay(!0,(function(){setTimeout(n.setState,0,"is-seamless",!1)})))})),n.on("config",(function(r){var o=a(r,"data.brand_color"),i=a(r,"data.metadata.player_id");if(o&&i&&_t(e,i,o),!("string"==typeof t.src&&k(t.src,{})||t.src&&t.src.length&&"ovp/base64"===t.src[0].type))return"string"==typeof t.player_id&&a(t,"metadata.player_id")!==t.player_id?G(n,t.player_id):void 0})),n.on("ovp:request:playlist:complete",(function(t){0!=n.reaper&&"object"==typeof t.data&&flowplayer.playlist(e,t.data)})),n.on("ovp:live:countdown:start",(function(r){0!=n.reaper&&"object"==typeof r.data&&(n.setOpts(r.data),n.setAttrs(r.data),n.render("live/countdown",[t,e,n]))})),n.on("timeupdate",(function(){t.live||t.recommendations&&a(t,"metadata.media_id")&&(Array.isArray(t.recommendations)||n.currentTime/n.duration<.8||$()||Z(n,a(t,"metadata.media_id"),a(t,"metadata.player_id")))}))}return ht.onumd=function(t){t.components.put("live/countdown",{onrender:mt,onremove:vt})},ht.wants=k,function(t,e){if("object"==typeof exports&&"undefined"!=typeof module)return e;"flowplayer"in t||(t.flowplayer={extensions:[]});var n=t.flowplayer;"function"==typeof n?n(e):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(e)||n.extensions.push(e))}("undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n(ht,{events:V,Decode:M,Loader:X})),ht}));
