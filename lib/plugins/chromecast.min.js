!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).flowplayer=e.flowplayer||{},e.flowplayer.chromecast=t())}(this,(function(){"use strict";var e=[].slice;function t(e,t,n){for(t=function(e){return Array.isArray(e)?e.slice(0):e.split(".")}(t);t.length;){if(null==e)return n;e=e[t.shift()]}return null==e?n:e}function n(e){var t=document.createElement("a");t.href=e;var n=t.pathname&&t.pathname.split(".");return n.length>1&&n[n.length-1]}function r(e){switch(e){case"video/mpd":return"application/dash+xml";case"video/m3u8":return"application/x-mpegurl";default:return e}}function a(e){var t=e.split("{"),a=t[1];return a?a.slice(0,-1).split(",").map((function(e){return{src:t[0]+e,type:r("video/"+e)}})):[{src:e,type:r("video/"+n(e))}]}function o(e){return"function"==typeof e}function i(){throw new Error("Function was expected as Argument[0]")}var c=[].slice;function u(e){if(!(this instanceof u))return new u(e);var t=this;return t.data=e,t.tap=function(){var e=c.call(arguments),n=e.shift();return n==u.lift?t.data:o(n)?(n.apply(t,[t.data].concat(e)),t):void i()},t.into=t.fmap=function(){var e=c.call(arguments),n=e.shift();return n==u.lift?t.data:o(n)?u(n.apply(t,[t.data].concat(e))):void i()},t.unwrap=function(){return t.data},t}u.of=u,u.lift=function(e){return e instanceof u?e.data:e},u._apply=u.apply=function(e,t){if(0==t.length)return e();if(1==t.length)return e(t[0]);if(2==t.length)return e(t[0],t[1]);if(3==t.length)return e(t[0],t[1],t[2]);if(4==t.length)return e(t[0],t[1],t[2],t[3]);if(5==t.length)return e(t[0],t[1],t[2],t[3],t[4]);throw new Error("Pipe._apply() does not support arity > 5")},u.maybe=function(e,t,n){return e?u._apply(t,[e].concat(c.call(arguments,2,arguments.length))):e},u.curry=function(e,t,n){return(t=t||[]).length>e.length-1?e.apply(n,t):function(){var r=t.concat(c.call(arguments));return u.curry(e,r,n)}};function s(){return l().fmap(u.maybe,(function(e){return e.getCurrentSession()}))}function f(){return s().fmap(u.maybe,(function(e){return e.getMediaSession()}))}function l(){return u.of(window).fmap(t,"cast.framework.CastContext").fmap(u.maybe,(function(e){return e.getInstance()}))}function p(){return t(window,"flowplayer.instances",[])}function d(){return p().filter((function(e){return q.is_same(e)}))}function m(){return p().filter((function(e){return!q.is_same(e)}))}function y(e,t){d().forEach((function(n){n.emit(e,t)}))}function v(e,t){m().forEach((function(n){n.emit(e,t)}))}function h(e,t){p().forEach((function(n){n.emit(e,t)}))}var g={PAUSED:"isPaused",CURRENT_TIME:"currentTime",DURATION:"duration",CONNECTED:"isConnected",PLAYER_STATE:"playerState",SAVED_STATE:"savedPlayerState",DISPLAY_NAME:"displayName",STATUS:"statusText"},w={player:void 0,controller:void 0};function E(){w.player=new cast.framework.RemotePlayer,w.controller=new cast.framework.RemotePlayerController(w.player),w.controller.addEventListener(cast.framework.RemotePlayerEventType.ANY_CHANGE,_),w.controller.addEventListener(cast.framework.RemotePlayerEventType.MEDIA_INFO_CHANGED,(function(){v("chromecast:idle")}))}function _(e){y("chromecast:field:update",e)}function S(e){var n=[].slice.call(e.querySelectorAll("track")),r=t(e,"hls.subtitleTracks",[]);return[].concat.apply([],n,r).filter((function(e){return"string"==typeof e.lang}))}function T(e){return S(e).map((function(e,t){var n=new chrome.cast.media.Track(t,chrome.cast.media.TrackType.TEXT);return n.trackContentType="text/vtt",n.subtype=chrome.cast.media.TextTrackType.SUBTITLES,n.trackContentId=e.src||e.url,n.name=e.label||e.name,n.language=e.lang,n}))}function b(e){k().fmap(u.maybe,(function(t){var n=new chrome.cast.media.EditTracksInfoRequest(e);t.editTracksInfo(n,console.debug,console.error)}))}var C=Object.freeze({__proto__:null,getCurrentSession:s,getMediaSession:f,getCastContext:l,players:p,casting_players:d,idle_players:m,broadcast_to_active:y,broadcast_to_idle:v,broadcast:h,FIELDS:g,SINGLETONS:w,refresh_singletons:E,onremotechange:_,tracks:S,cast_tracks:T,editTracks:b});function A(e,n,r){s().fmap(u.maybe,(function(n){var a=q.get_media(e);if(a){var o=new chrome.cast.media.MediaInfo(a.src,a.type);o.tracks=T(e),o.metadata=new chrome.cast.media.GenericMediaMetadata;var i=new chrome.cast.media.LoadRequest(o);isNaN(e.currentTime)||(i.currentTime=e.currentTime),o.tracks.length&&(i.activeTrackIds=S(e).filter((function(e){return"showing"==t(e,"track.mode",e.mode)})).map((function(e,t){return t}))),console.debug("cast:request(%o)",i),n.loadMedia(i).then((function(){HTMLMediaElement.prototype.pause.call(e),E(),v("chromecast:idle")}),r)}}))}function k(){return f()}function N(){return!!f().unwrap()}function x(){return!!s().unwrap()}function L(){return k().fmap(u.maybe,t,"media.duration").unwrap()}function I(){return k().fmap(u.maybe,t,"playerState").unwrap()}function O(e){return e?P(e):k().fmap(u.maybe,(function(e){return e.getEstimatedTime()})).unwrap()}function P(e){return k().fmap(u.maybe,(function(t){var n=new chrome.cast.media.SeekRequest;return n.currentTime=e,t.seek(n)})),e}function M(){return k().fmap(u.maybe,(function(e){return e.play()})).unwrap()}function j(){return k().fmap(u.maybe,(function(e){return e.pause()})).unwrap()}var D=Object.freeze({__proto__:null,load:A,media:k,has_media:N,exists:x,device_name:function(){return s().fmap(u.maybe,(function(e){return e.getCastDevice().friendlyName})).unwrap()},duration:L,state:I,currentTime:O,seek:P,play:M,pause:j});var R=/(video\/mp4)|(application\/x-mpegurl)|(video\/mpd)|(application\/dash\+xml)/;function q(e){this.video=e,function(e,t){var n={play:function(){return q.is_same(t)?M():N()?q.load(t):void q.load(t)},pause:function(){return q.is_same(t)?j():HTMLMediaElement.prototype.pause.call(t)}};n.currentTime={get:O,set:O},n.duration={get:L},n.paused={get:function(){return"PAUSED"===I()}},n.playing={get:function(){return"PLAYING"===I()}},Object.keys(n).forEach((function(e){if("object"==typeof n[e])return Object.defineProperty(t,e,{get:function(){return q.is_same(t)?n[e].get():Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,e).get.call(this)},set:function(r){return q.is_same(t)?n[e].set(r):Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,e).set.call(this,r)}});var r=t[e];t[e]=function(){var t=[].slice.apply(arguments);return x()?n[e].apply(this,t):r.apply(this,t)}}))}(0,e)}function H(){}q.of=function(e){return e.sender||(e.sender=new q(e)),e.sender},q.normalize_src=function(e){return u.of(e).fmap(t,"opts.src",[]).fmap((function(e){return"string"==typeof e?a(e):e})).fmap((function(e){return e.map((function(e){return"string"==typeof e?a(e):e}))})).fmap((function(e){return[].concat.apply([],e)})).fmap((function(e){return e.filter(q.is_supported_media)}))},q.is_same=function(e){const n=q.normalize_src(e).unwrap().map((function(e){return t(e,"src")}));return k().fmap(u.maybe,t,"media.contentId").fmap(u.maybe,(function(e){return!!~n.indexOf(e)})).unwrap()},q.maybe=function(e,t){e.sender&&t(e.sender,e)},q.getEstimatedTime=function(){return f().fmap(u.maybe,(function(e){return e.getEstimatedTime()})).unwrap()},q.is_supported_media=function(e){return t(e,"type","").toString().match(R)},q.load=function(e){A(e,console.debug,console.error)},q.destroy=function(e){e.video=0},q.get_media=function(e){return q.normalize_src(e).fmap(u.maybe,(function(e){return e.pop()})).unwrap()};var U="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1";function G(){if(document.querySelector("script[src='"+U+"']"))return Y();var e,t,n,r;e=U,n=document.getElementsByTagName("head")[0],(r=document.createElement("script")).src=e,r.onload=r.onerror=t||H,n.appendChild(r),window.__onGCastApiAvailable=function(){!function(){if(!F())return;l().fmap(u.maybe,(function(e){e.setOptions({receiverApplicationId:"6F71FA7C",autoJoinPolicy:chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),e.addEventListener(cast.framework.CastContextEventType.CAST_STATE_CHANGED,(function(e){h("chromecast:state:changed",e)})),e.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED,(function(e){E(),h("chromecast:session:changed",e)}))}))}(),Y()}}function F(){return"object"==typeof window.cast}function Y(){if(F())return h("chromecast:available");h("chromecast:unavailable")}var z="is-chromecast-playing",B=!!function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("testPassive",null,t),window.removeEventListener("testPassive",null,t)}catch(e){}return e}()&&{passive:!0},J=["touchstart","touchmove"];function W(e){return e.emit=function(t,n,r){r=r||{};var a=function(e){var t=document.createEvent("Event");return t.initEvent(e,!1,!0),t}(t);return n&&function(e,t){for(var n in t)e[n]=t[n]}(a,{data:n||{}}),e.dispatchEvent(a),!1===r.return_self?a:e},e.on=function(t,n){return"string"==typeof t&&(t=t.split(" ")),t.forEach((function(t){return function(e){return~J.indexOf(e)}(t)?e.addEventListener(t,n,B):e.addEventListener(t,n)})),e},e.off=function(t,n){return e.removeEventListener(t,n),e},e.one=e.once=function(t,n){return e.on(t,(function r(a){e.off(t,r),n(a)}))},e}var V=Array.isArray,X="undefined"!=typeof window&&W(window),K="undefined"!=typeof document&&W(document),Q=["span","a","em","p","i"],Z=Q.concat(["div","strong","video","img","ol","ul","li","script"]);function $(e,t,n){var r=te(document.createElement(e));if(V(t)&&(n=t,t=!1),V(n)||(n=[n]),r.append(n.filter((function(e){return e}))),"object"!=typeof t)return r;for(var a in t)a in r?r[a]=t[a]:r.setAttribute(a,t[a]);return r}function ee(t){var n=t.tagName;t.__flowplayer__=1,t.find=function(e){var n=t.querySelector(e);return n?te(n):n},t.html=function(e){return t.innerHTML=e,t},t.empty=function(){return t.innerHTML="",t},t.offset=function(){var e={top:0,left:0},n=t;do{e.left+=n.offsetLeft||0,e.top+=n.offsetTop||0}while(n=n.offsetParent);return e},t.innerWidth=function(){var e=getComputedStyle(t);return t.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)};var r=t.insert=function(e,n){return V(n)?n.map((function(n){return t.insert(e,n)}))[0]:te(n="string"==typeof n?t.insertAdjacentHTML(e,n):t.insertAdjacentElement?t.insertAdjacentElement(e,n):t.appendChild(n))};return t.append=r.bind(t,"beforeend"),t.prepend=r.bind(t,"afterbegin"),t.css=function(e,n){if("object"==typeof e){for(var r in e)t.css(r,e[r]);return t}return void 0===n?getComputedStyle(t)[e]:(1*n&&(n+="px"),t.style[e]=n,t)},t.show=function(){return t.css({display:~Q.indexOf(n)?"inline":"block"})},t.hide=function(){return t.css({display:"none"})},t.remove=function(){var e=t.parentNode;e&&e.removeChild(t)},t.attr=function(e,n){return null==n?t.getAttribute(e):(t.setAttribute(e,n),t)},t.txt=function(e){return t.textContent=e,t},t.fp=function(e){return t.addClass("fp-"+e)},t.addClass=function(e){return e.split(" ").forEach((function(e){t.hasClass(e)||(t.className+=(t.className?" ":"")+e)})),t},t.removeClass=function(e){e=e.split(" ");var n=t.className.split(" ");return t.className=n.filter((function(t){return!~e.indexOf(t)})).join(" "),t},t.toggleClass=function(e,n){return void 0===n&&(n=!t.hasClass(e)),n?t.addClass(e):t.removeClass(e)},t.findAll=function(n){return r=t.querySelectorAll(n),e.call(r);var r},t.hasClass=function(e){return~t.className.split(" ").indexOf(e)},t}function te(e){return void 0===e||function(e){return e&&e.__flowplayer__}(e)?e:ee(W(e))}function ne(e,t){if("string"==typeof e&&"<"==e[0])return $(e.slice(1,-1),t);if("string"!=typeof e)return te(e);var n=t instanceof HTMLElement&&t.querySelector(".fp-"+e)||document.querySelector(e);return n?te(n):void 0}ne.window=X,ne.document=K,ne.el=$,Z.forEach((function(e){ne[e]=function(t,n){return"string"==typeof t&&(t={class:t}),$(e,t,n)}}));var re="mount",ae="timeupdate",oe="pause",ie="playing",ce="reap";var ue="is-starting";return window.CastSession=D,window.CastUtils=C,function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});var n=e.flowplayer;return"function"==typeof n?(n(t),t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t),t)}(window,(function(e,n,r){"https:"!==location.protocol&&"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname&&console.warn("Secure URL required to enable Chromecast"),G();var a={pending:void 0};r.on(ce,(function(){q.maybe(r,q.destroy)})),r.on(re,(function(){var a,o,i,c,u=t(n,"middle");u&&(a=u,o={poster:e.poster},i=ne.div("fp-chromecast"),c=ne.el("p"),o.poster&&(i.style.backgroundImage=["url(",o.poster,")"].join("")),i.append(c),a.prepend(i));var f=t(n,"ui.header.secondary");f&&function(e,t){var n=ne.el("span").addClass("fp-cast-button");n.append(ne.el("google-cast-launcher")),e.prepend(n),n.on("click",(function(){const e=s().unwrap();if(e)return e.endSession(!0);t.emit("chromecast:start")}))}(f,r)})),r.on("chromecast:available",(function(){r.setState("is-cast-available",!0),q.of(r)})),r.on("chromecast:unavailable",(function(){r.setState("is-cast-available",!1),q.maybe(r,q.destroy)})),r.on("chromecast:start",(function(){if(N())return q.load(r);a.pending=!0})),r.on("tracks:text:updated",(function(e){if(N())return e.data?void b(S(r).map((function(e,t){return{track:e.track,id:t}})).filter((function(t){return t.track==e.data})).map((function(e){return e.id}))):b([])})),r.on("chromecast:idle",(function(){r.setState(z,!1),r.setState(ue,!0)})),r.on("chromecast:field:update",(function(e){var n=t(e,"data.field"),a=t(e,"data.value");switch(n){case g.CURRENT_TIME:return r.emit(ae,a);case g.PLAYER_STATE:return"PLAYING"==a?r.emit(ie):"PAUSED"==a?r.emit(oe):void 0;case"mediaInfo":var o=(a||{}).fake_session||D;return function(e,n){if(0!=e.root){var r=e.root.querySelector(".fp-chromecast p");if(r){var a="";a=(a=e._t("chromecast.message","{{state}} on {{device}}").replace("{{device}}",t(n,"device","chromecast"))).replace("{{state}}",t(n,"state","").toLowerCase()),r.txt(a)}}}(r,{device:o.device_name(),state:o.state()}),o.hide_controls&&r.setState("no-chromecast-controls",!0),r.setState(ue,!1),r.setState(z,!0)}})),r.on("chromecast:session:changed",(function(e){switch(t(e,"data.sessionState")){case cast.framework.SessionState.SESSION_ENDED:return r.setState(z,!1);case cast.framework.SessionState.SESSION_RESUMED:case cast.framework.SessionState.SESSION_STARTED:a.pending&&(a.pending=!1,q.load(r))}}))}))}));
